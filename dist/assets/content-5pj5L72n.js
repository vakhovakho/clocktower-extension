class l extends Error{}l.prototype.name="InvalidTokenError";function k(t){return decodeURIComponent(atob(t).replace(/(.)/g,(e,n)=>{let r=n.charCodeAt(0).toString(16).toUpperCase();return r.length<2&&(r="0"+r),"%"+r}))}function T(t){let e=t.replace(/-/g,"+").replace(/_/g,"/");switch(e.length%4){case 0:break;case 2:e+="==";break;case 3:e+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return k(e)}catch{return atob(e)}}function h(t,e){if(typeof t!="string")throw new l("Invalid token specified: must be a string");e||(e={});const n=e.header===!0?0:1,r=t.split(".")[n];if(typeof r!="string")throw new l(`Invalid token specified: missing part #${n+1}`);let s;try{s=T(r)}catch(a){throw new l(`Invalid token specified: invalid base64 for part #${n+1} (${a.message})`)}try{return JSON.parse(s)}catch(a){throw new l(`Invalid token specified: invalid json for part #${n+1} (${a.message})`)}}const b="LOAD_STYLES",E="UNLOAD_STYLES",C="STORE_ACCESS_TOKEN",w="REMOVE_ACCESS_TOKEN",I={childList:!0,subtree:!0},m=new MutationObserver(t=>{var r;let e=document.querySelectorAll("#whispers li.video.storyteller"),n=document.querySelectorAll("ul.storytellers li.storyteller");for(let s=0;s<n.length;s++){let a=(r=n[s].querySelector("div.name span"))==null?void 0:r.innerText;for(let o=0;o<e.length;o++){let S=e[o].querySelector(".chat"),i=e[o].querySelector(".video"),p=e[o].querySelector(".audio"),c=e[o].querySelector(".name"),v=e[o].querySelector(".token");if(c.innerText.trim().startsWith(a)){e[o].style.position="fixed",e[o].style.bottom="106px",e[o].style.width="min(26vw, 26vh)",e[o].style[s===0?"left":"right"]="80px",S.style.borderRadius="50%",i.style.borderRadius="50%",i.style.borderColor="#6fbc6f",c.style.display="none",v.style.display="none",p.style.display="none";break}}}});function g(){let t=setInterval(()=>{const e=document.getElementById("center");e&&(m.observe(e,I),clearInterval(t))},2e3)}function O(){m.disconnect()}async function y(){const t=chrome.runtime.getURL("custom-css.css");return fetch(t).then(e=>e.text()).then(e=>{let n=document.getElementById("mastermind-style");n&&n.remove();var r=document.createElement("style");r.id="mastermind-style",r.type="text/css",r.innerHTML=e,document.head.appendChild(r)})}const A="http://localhost:8000/v1/";function L(t){return t.history.length>1&&t.history[t.history.length-1].type==="end"}function D(){let t=localStorage.getItem("mastermindAccessToken");if(t){if(h(t).exp>Date.now())return!0;localStorage.removeItem("mastermindAccessToken")}return!1}window.onload=function(){if(!D()){setTimeout(()=>{alert("You are not authorized to use this extension. Please log in and try again.")},5e3);return}_()&&f()};let d=!1;function f(){if(d)return;d=!0;let t={phase:-1,ended:!1};setInterval(()=>{console.log("tracking");let e=N();e.game.history.length!==0&&(e.game.isRunning&&e.game.phase!==t.phase?(t.phase=e.game.phase,t.ended=!1,u(e)):L(e.game)&&!t.ended&&(t.ended=!0,t.phase=-1,u(e)))},5e3)}function _(){let t=localStorage.getItem("token"),e=h(t).id,r=JSON.parse(localStorage.getItem("storytellers")).some(s=>s.id===e);return r||console.log("not a storyteller"),r}function u(t){fetch(A+"save-phase",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"JWT "+localStorage.getItem("mastermindAccessToken")||""},body:JSON.stringify({data:t})}).then(e=>{e.ok||(console.log("something went wrong: "+e.status+" "+e.statusText),(e.status===401||e.status===403)&&alert("You are not authorized to use this extension. Please log in and try again."))})}chrome.storage.local.get(["styleLoaded"]).then(async t=>{if(t.styleLoaded===1)try{await y(),g()}catch(e){console.error(e)}});chrome.runtime.onMessage.addListener(function(t,e,n){switch(t.action){case b:y(),g();break;case E:let r=document.getElementById("mastermind-style");r&&r.remove(),O();break;case"ALERT":alert(t.message);case C:localStorage.setItem("mastermindAccessToken",t.token),f();break;case w:localStorage.removeItem("mastermindAccessToken");break}});function N(){let t={};for(let e=0;e<localStorage.length;e++){let n=localStorage.key(e),r=localStorage.getItem(n);(r.startsWith("{")||r.startsWith("["))&&(r=JSON.parse(r)),t[n]=r}return t}
