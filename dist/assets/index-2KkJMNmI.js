(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))t(r);new MutationObserver(r=>{for(const a of r)if(a.type==="childList")for(const s of a.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&t(s)}).observe(document,{childList:!0,subtree:!0});function n(r){const a={};return r.integrity&&(a.integrity=r.integrity),r.referrerPolicy&&(a.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?a.credentials="include":r.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function t(r){if(r.ep)return;r.ep=!0;const a=n(r);fetch(r.href,a)}})();class d extends Error{}d.prototype.name="InvalidTokenError";function N(e){return decodeURIComponent(atob(e).replace(/(.)/g,(o,n)=>{let t=n.charCodeAt(0).toString(16).toUpperCase();return t.length<2&&(t="0"+t),"%"+t}))}function x(e){let o=e.replace(/-/g,"+").replace(/_/g,"/");switch(o.length%4){case 0:break;case 2:o+="==";break;case 3:o+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return N(o)}catch{return atob(o)}}function w(e,o){if(typeof e!="string")throw new d("Invalid token specified: must be a string");o||(o={});const n=o.header===!0?0:1,t=e.split(".")[n];if(typeof t!="string")throw new d(`Invalid token specified: missing part #${n+1}`);let r;try{r=x(t)}catch(a){throw new d(`Invalid token specified: invalid base64 for part #${n+1} (${a.message})`)}try{return JSON.parse(r)}catch(a){throw new d(`Invalid token specified: invalid json for part #${n+1} (${a.message})`)}}const R="LOAD_STYLES",_="UNLOAD_STYLES",T="STORE_ACCESS_TOKEN",C="REMOVE_ACCESS_TOKEN",f="https://api.clocktower.ge/v1/";let v={PLAYER:"player",STORYTELLER:"storyteller",SPECTATOR:"spectator"},L={game:null,session:null,bocToken:null,bocId:null,userType:null,players:[],storytellers:[],spectators:[]},c=L,i=document.querySelector(".wrapper"),y=document.getElementById("style"),u=document.getElementById("translate"),m=document.getElementById("background"),b=document.querySelector(".controls");b.style.display="none";chrome.storage.local.get(["styleLoaded"],function(e){e.styleLoaded&&(y.checked=!0)});chrome.storage.local.get(["translate"],function(e){e.translate&&(u.checked=!0)});chrome.storage.local.get(["background"],function(e){e.background&&(m.checked=!0)});y.addEventListener("change",I);u.addEventListener("change",E);m.addEventListener("change",O);chrome.runtime.onMessage.addListener(function(e,o,n){console.log("localStorage change detected",e.data),e.gameEnded&&console.log("localStorage change detected",e.data)});p(function(){return{token:localStorage.getItem("token"),game:JSON.parse(localStorage.getItem("game")),players:JSON.parse(localStorage.getItem("players")),storytellers:JSON.parse(localStorage.getItem("storytellers")),session:localStorage.getItem("session"),playerNames:[...document.querySelectorAll(".nameplate span")].map(e=>e.textContent)}},function(e){P(e)});function P(e){let{token:o,game:n,players:t,storytellers:r,session:a,playerNames:s}=e;if(!o){k("You must be logged in to rate players.");return}c.bocToken=o,c.bocId=w(o).id,c.game=n,c.players=t,c.session=a,c.storytellers=r,c.playerNames=s,t.find(l=>l.id===c.bocId)?c.userType=v.PLAYER:r.find(l=>l.id===c.bocId)&&(c.userType=v.STORYTELLER),M()?S():A()}function I(){y.checked?(chrome.storage.local.set({styleLoaded:1}),chrome.tabs.query({active:!0,currentWindow:!0},function(e){chrome.tabs.sendMessage(e[0].id,{action:R})})):(chrome.storage.local.set({styleLoaded:0}),chrome.tabs.query({active:!0,currentWindow:!0},function(e){chrome.tabs.sendMessage(e[0].id,{action:_})}))}function E(){chrome.storage.local.set({translate:Number(u.checked)}),chrome.runtime.sendMessage({translate:u.checked},()=>{p(function(){window.location.reload()})})}function O(){chrome.storage.local.set({background:Number(m.checked)}),m.checked?p(function(){localStorage.setItem("background","https://api.clocktower.ge/v1/background"),window.location.reload()}):p(function(){localStorage.removeItem("background"),window.location.reload()})}function M(){let e=localStorage.getItem("accessToken");if(e){if(e==="undefined")return localStorage.removeItem("accessToken"),!1;if(w(e).exp>Date.now())return!0;localStorage.removeItem("accessToken")}return!1}function A(){b.style.display="none",i.innerHTML="";let e=document.createElement("div");e.classList.add("auth-container");let o=document.createElement("div"),n=document.createElement("label");n.textContent="username",n.for="username";let t=document.createElement("input");t.setAttribute("name","username"),t.setAttribute("id","username"),o.appendChild(n),o.appendChild(t);let r=document.createElement("div"),a=document.createElement("label");a.textContent="password",a.for="password";let s=document.createElement("input");s.setAttribute("type","password"),s.setAttribute("name","password"),s.setAttribute("id","password"),r.appendChild(a),r.appendChild(s);let l=document.createElement("div"),h=document.createElement("button");h.textContent="Login";let g=document.createElement("button");g.textContent="Register",l.appendChild(h),l.appendChild(g),e.appendChild(o),e.appendChild(r),e.appendChild(l),i.appendChild(e),h.addEventListener("click",()=>Y(t.value,s.value,c.bocId)),g.addEventListener("click",()=>D(t.value,s.value,c.bocId))}function Y(e,o,n){fetch(f+"auth/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:e,password:o,bocId:n})}).then(t=>t.json()).then(t=>{if(t.status==="fail")throw new Error(t.message);localStorage.setItem("accessToken",t.accessToken),chrome.tabs.query({active:!0,currentWindow:!0},function(r){chrome.tabs.sendMessage(r[0].id,{action:T,token:t.accessToken})}),I(),E(),O(),S()}).catch(t=>{alert("Error: "+t.message)})}function D(e,o,n){fetch(f+"auth/register",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:e,password:o,bocId:n})}).then(t=>t.json()).then(t=>{if(t.status==="fail")throw new Error(t.message);localStorage.setItem("accessToken",t.accessToken),chrome.tabs.query({active:!0,currentWindow:!0},function(r){chrome.tabs.sendMessage(r[0].id,{action:T,token:t.accessToken})}),S()}).catch(t=>{alert("Error: "+t.message)})}function q(e,o){return fetch(f+"vote",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"JWT "+localStorage.getItem("accessToken")||""},body:JSON.stringify({gameId:e,receiverId:o})}).then(n=>(n.ok||(n.status===401||n.status===403?(localStorage.removeItem("accessToken"),chrome.tabs.query({active:!0,currentWindow:!0},function(t){chrome.tabs.sendMessage(t[0].id,{action:C})}),A()):console.log(n)),n.json())).then(n=>{if(n.status==="fail")throw new Error(n.message);alert("Vote sent")}).catch(n=>{alert("Error: "+n.message)})}function j(){localStorage.removeItem("accessToken"),chrome.tabs.query({active:!0,currentWindow:!0},function(e){chrome.tabs.sendMessage(e[0].id,{action:C}),u.checked=!1,E()})}function S(){b.style.display="block",i.innerHTML="";let e=document.createElement("span");if(e.classList.add("logout"),e.textContent="Logout",e.addEventListener("click",j),i.appendChild(e),!c.userType){k("You must be a player or storyteller to rate players.");return}for(let n in c.players){let t=c.players[n].id,r=c.playerNames[n],a=document.createElement("div");a.classList.add("player");let s=document.createElement("label");s.setAttribute("for",t+"_"+n),s.textContent=r;let l=document.createElement("input");l.type="radio",l.setAttribute("name","vote"),l.value=t,l.id=t+"_"+n,a.appendChild(s),a.appendChild(l),i.appendChild(a)}let o=document.createElement("button");o.textContent="Rate",o.addEventListener("click",J),i.appendChild(o)}function J(){let e=document.querySelector('input[name="vote"]:checked');if(!e){alert("Please select a player to vote");return}let o=e.value;q(W(c.game,c.session),o).then(()=>{i.querySelector("button").disabled=!0})}function W(e,o){return(Array.isArray(e.history[0])?e.history[0][0]:e.history[0]).time+":"+o}function p(e,o){chrome.tabs.query({active:!0,currentWindow:!0},function(n){const t=n[0];t&&(t.url.includes("botc.app")?chrome.scripting.executeScript({target:{tabId:t.id},function:e},function(r){o&&o(r[0].result)}):k("You must be on the Blood on the Clocktower website to use this extension."))})}function k(e){let o=document.createElement("div");o.textContent=e,i.appendChild(o),o.classList.add("error"),c=L}
