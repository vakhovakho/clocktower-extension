(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))t(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const c of s.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&t(c)}).observe(document,{childList:!0,subtree:!0});function r(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function t(n){if(n.ep)return;n.ep=!0;const s=r(n);fetch(n.href,s)}})();class m extends Error{}m.prototype.name="InvalidTokenError";function _(e){return decodeURIComponent(atob(e).replace(/(.)/g,(o,r)=>{let t=r.charCodeAt(0).toString(16).toUpperCase();return t.length<2&&(t="0"+t),"%"+t}))}function P(e){let o=e.replace(/-/g,"+").replace(/_/g,"/");switch(o.length%4){case 0:break;case 2:o+="==";break;case 3:o+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return _(o)}catch{return atob(o)}}function f(e,o){if(typeof e!="string")throw new m("Invalid token specified: must be a string");o||(o={});const r=o.header===!0?0:1,t=e.split(".")[r];if(typeof t!="string")throw new m(`Invalid token specified: missing part #${r+1}`);let n;try{n=P(t)}catch(s){throw new m(`Invalid token specified: invalid base64 for part #${r+1} (${s.message})`)}try{return JSON.parse(n)}catch(s){throw new m(`Invalid token specified: invalid json for part #${r+1} (${s.message})`)}}const j="LOAD_STYLES",D="UNLOAD_STYLES",v="STORE_ACCESS_TOKEN",L="REMOVE_ACCESS_TOKEN",p="https://api.clocktower.ge/v1/";let w={PLAYER:"player",STORYTELLER:"storyteller",SPECTATOR:"spectator"},I={game:null,session:null,bocToken:null,bocId:null,userType:null,players:[],storytellers:[],spectators:[],reportedUsers:[],isModerator:!1,loaderCount:0},a=I,d=document.querySelector(".wrapper"),S=document.getElementById("style"),h=document.getElementById("translate"),g=document.getElementById("background"),T=document.querySelector(".controls"),u=document.querySelector(".info"),O=document.querySelector(".loader-wrapper");T.style.display="none";chrome.storage.local.get(["styleLoaded"],function(e){e.styleLoaded&&(S.checked=!0)});chrome.storage.local.get(["translate"],function(e){e.translate&&(h.checked=!0)});chrome.storage.local.get(["background"],function(e){e.background&&(g.checked=!0)});S.addEventListener("change",A);h.addEventListener("change",k);g.addEventListener("change",Y);chrome.runtime.onMessage.addListener(function(e,o,r){console.log("localStorage change detected",e.data),e.gameEnded&&console.log("localStorage change detected",e.data)});y(function(){return{token:localStorage.getItem("token"),game:JSON.parse(localStorage.getItem("game")),players:JSON.parse(localStorage.getItem("players")),storytellers:JSON.parse(localStorage.getItem("storytellers")),session:localStorage.getItem("session"),playerNames:[...document.querySelectorAll(".nameplate span")].map(e=>e.textContent)}},function(e){U(e)});function U(e){let{token:o,game:r,players:t,storytellers:n,session:s,playerNames:c}=e;if(!o){C("You must be logged in to rate players.");return}a.bocToken=o,a.bocId=f(o).id,a.game=r,a.players=t,a.session=s,a.storytellers=n,a.playerNames=c,localStorage.getItem("accessToken")&&(a.isModerator=f(localStorage.getItem("accessToken")).moderator,N(),K()),t.find(l=>l.id===a.bocId)?a.userType=w.PLAYER:n.find(l=>l.id===a.bocId)&&(a.userType=w.STORYTELLER),q()?E():x()}function A(){S.checked?(chrome.storage.local.set({styleLoaded:1}),chrome.tabs.query({active:!0,currentWindow:!0},function(e){chrome.tabs.sendMessage(e[0].id,{action:j})})):(chrome.storage.local.set({styleLoaded:0}),chrome.tabs.query({active:!0,currentWindow:!0},function(e){chrome.tabs.sendMessage(e[0].id,{action:D})}))}function k(){chrome.storage.local.set({translate:Number(h.checked)}),chrome.runtime.sendMessage({translate:h.checked},()=>{y(function(){window.location.reload()})})}function Y(){chrome.storage.local.set({background:Number(g.checked)}),g.checked?y(function(){localStorage.setItem("background","https://api.clocktower.ge/v1/background"),window.location.reload()}):y(function(){localStorage.removeItem("background"),window.location.reload()})}function q(){let e=localStorage.getItem("accessToken");if(e){if(e==="undefined")return localStorage.removeItem("accessToken"),!1;if(f(e).exp>Date.now())return!0;localStorage.removeItem("accessToken")}return!1}function x(){T.style.display="none",d.innerHTML="";let e=document.createElement("div");e.classList.add("auth-container");let o=document.createElement("div"),r=document.createElement("label");r.textContent="username",r.for="username";let t=document.createElement("input");t.setAttribute("name","username"),t.setAttribute("id","username"),o.appendChild(r),o.appendChild(t);let n=document.createElement("div"),s=document.createElement("label");s.textContent="password",s.for="password";let c=document.createElement("input");c.setAttribute("type","password"),c.setAttribute("name","password"),c.setAttribute("id","password"),n.appendChild(s),n.appendChild(c);let l=document.createElement("div"),i=document.createElement("button");i.textContent="Login";let b=document.createElement("button");b.textContent="Register",l.appendChild(i),l.appendChild(b),e.appendChild(o),e.appendChild(n),e.appendChild(l),d.appendChild(e),i.addEventListener("click",()=>W(t.value,c.value,a.bocId)),b.addEventListener("click",()=>J(t.value,c.value,a.bocId))}function W(e,o,r){fetch(p+"auth/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:e,password:o,bocId:r})}).then(t=>t.json()).then(t=>{if(t.status==="fail")throw new Error(t.message);localStorage.setItem("accessToken",t.accessToken),a.isModerator=f(t.accessToken).moderator,a.isModerator&&N(),chrome.tabs.query({active:!0,currentWindow:!0},function(n){chrome.tabs.sendMessage(n[0].id,{action:v,token:t.accessToken})}),A(),k(),E()}).catch(t=>{alert("Error: "+t.message)})}function J(e,o,r){fetch(p+"auth/register",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:e,password:o,bocId:r})}).then(t=>t.json()).then(t=>{if(t.status==="fail")throw new Error(t.message);localStorage.setItem("accessToken",t.accessToken),chrome.tabs.query({active:!0,currentWindow:!0},function(n){chrome.tabs.sendMessage(n[0].id,{action:v,token:t.accessToken})}),E()}).catch(t=>{alert("Error: "+t.message)})}function B(e,o){return fetch(p+"vote",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"JWT "+localStorage.getItem("accessToken")||""},body:JSON.stringify({gameId:e,receiverId:o})}).then(r=>(r.ok||(r.status===401||r.status===403?(localStorage.removeItem("accessToken"),chrome.tabs.query({active:!0,currentWindow:!0},function(t){chrome.tabs.sendMessage(t[0].id,{action:L})}),x()):console.log(r)),r.json())).then(r=>{if(r.status==="fail")throw new Error(r.message);alert("Vote sent")}).catch(r=>{alert("Error: "+r.message)})}function $(){localStorage.removeItem("accessToken"),chrome.tabs.query({active:!0,currentWindow:!0},function(e){chrome.tabs.sendMessage(e[0].id,{action:L}),h.checked=!1,k()})}function E(){T.style.display="block",d.innerHTML="";let e=document.createElement("span");if(e.classList.add("logout"),e.textContent="Logout",e.addEventListener("click",$),d.appendChild(e),!a.userType&&!a.isModerator){C("You must be a player, storyteller or moderator  to rate players.");return}for(let r in a.players){let t=a.players[r].id,n=a.playerNames[r],s=document.createElement("div");s.classList.add("player");let c=document.createElement("label");c.setAttribute("for",t+"_"+r),c.textContent=n,a.reportedUsers.find(i=>i===t)&&(c.style.color="red",c.style.fontWeight="bold");let l=document.createElement("input");if(l.type="radio",l.setAttribute("name","vote"),l.value=t,l.id=t+"_"+r,s.appendChild(c),s.appendChild(l),a.isModerator){let i=document.createElement("button");i.textContent="Report",i.addEventListener("click",()=>z(t)),s.appendChild(i)}d.appendChild(s)}let o=document.createElement("button");o.textContent="Rate",o.addEventListener("click",V),d.appendChild(o)}function z(e){let o=prompt("Please enter the reason for reporting this player","");o===null||o===""||fetch(p+"report",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"JWT "+localStorage.getItem("accessToken")||""},body:JSON.stringify({reportedUserBocId:e,session:a.session,reason:o})}).then(r=>(r.ok||alert("Error: "+r.statusText),r.json())).then(r=>{if(r.status!=="success")throw new Error(r.message);alert("Report Sent")}).catch(r=>{alert("Error: "+r.message)})}function N(){R(),fetch(p+"report/get-all",{method:"GET",headers:{"Content-Type":"application/json",Authorization:"JWT "+localStorage.getItem("accessToken")||""}}).then(e=>(e.ok||alert("Error: "+e.statusText),e.json())).then(e=>{if(e.status!=="success")throw new Error(e.message);a.reportedUsers=e.data,E()}).catch(e=>{alert("Error: "+e.message)}).finally(()=>{M()})}function K(){R(),u.innerHTML="",u.classList.add("hidden"),fetch(p+"report/mine",{method:"GET",headers:{"Content-Type":"application/json",Authorization:"JWT "+localStorage.getItem("accessToken")||""}}).then(e=>(e.ok||alert("Error: "+e.statusText),e.json())).then(e=>{if(e.status!=="success")throw new Error(e.message);let o=document.createElement("h3");o.textContent="You are reported!";let r=document.createElement("p");r.textContent=`Reason: ${e.data.reason}`;let t=document.createElement("p");t.textContent=`Until: ${new Date(e.data.reportedUntil).toLocaleString()}`,u.appendChild(o),u.appendChild(r),u.appendChild(t),u.classList.remove("hidden")}).catch(e=>{alert("Error: "+e.message)}).finally(()=>{M()})}function V(){let e=document.querySelector('input[name="vote"]:checked');if(!e){alert("Please select a player to vote");return}let o=e.value;B(G(a.game,a.session),o).then(()=>{d.querySelector("button").disabled=!0})}function G(e,o){return(Array.isArray(e.history[0])?e.history[0][0]:e.history[0]).time+":"+o}function y(e,o){chrome.tabs.query({active:!0,currentWindow:!0},function(r){const t=r[0];t&&(t.url.includes("botc.app")?chrome.scripting.executeScript({target:{tabId:t.id},function:e},function(n){o&&o(n[0].result)}):C("You must be on the Blood on the Clocktower website to use this extension."))})}function C(e){let o=document.createElement("div");o.textContent=e,d.appendChild(o),o.classList.add("error"),a=I}function R(){a.loaderCount++,a.loaderCount>0&&O.classList.remove("hidden")}function M(){a.loaderCount--,a.loaderCount<=0&&O.classList.add("hidden")}
