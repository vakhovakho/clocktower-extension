class s extends Error{}s.prototype.name="InvalidTokenError";function p(t){return decodeURIComponent(atob(t).replace(/(.)/g,(e,o)=>{let n=o.charCodeAt(0).toString(16).toUpperCase();return n.length<2&&(n="0"+n),"%"+n}))}function y(t){let e=t.replace(/-/g,"+").replace(/_/g,"/");switch(e.length%4){case 0:break;case 2:e+="==";break;case 3:e+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return p(e)}catch{return atob(e)}}function d(t,e){if(typeof t!="string")throw new s("Invalid token specified: must be a string");e||(e={});const o=e.header===!0?0:1,n=t.split(".")[o];if(typeof n!="string")throw new s(`Invalid token specified: missing part #${o+1}`);let a;try{a=y(n)}catch(r){throw new s(`Invalid token specified: invalid base64 for part #${o+1} (${r.message})`)}try{return JSON.parse(a)}catch(r){throw new s(`Invalid token specified: invalid json for part #${o+1} (${r.message})`)}}const S="LOAD_STYLES",k="UNLOAD_STYLES",E="STORE_ACCESS_TOKEN",I="REMOVE_ACCESS_TOKEN";async function m(){const t=chrome.runtime.getURL("custom-css.css");return fetch(t).then(e=>e.text()).then(e=>{let o=document.getElementById("mastermind-style");o&&o.remove();var n=document.createElement("style");n.id="mastermind-style",n.type="text/css",n.innerHTML=e,document.head.appendChild(n)})}const T="https://api.clocktower.ge/v1/";window.onload=function(){chrome.storage.local.get(["styleLoaded"]).then(async e=>{if(w()&&e.styleLoaded===1)try{await m()}catch(o){console.error(o)}});let t=setInterval(()=>{h()&&!l&&(g(),clearInterval(t))},6e4)};let l=!1;function g(){l=!0;let t={phase:-1,ended:!1};setInterval(()=>{console.log("tracking");let e=A();e.game.history.length!==0&&(e.game.isRunning&&e.game.phase!==t.phase?(t.phase=e.game.phase,t.ended=!1,i(e),c(e)):v(e.game)&&!t.ended&&(t.ended=!0,t.phase=-1,i(e),c(e)))},5e3)}function i(t){t.voteHistory.forEach(e=>{let o=[...document.querySelectorAll("#center .circle li .name span")].map(f=>f.textContent),n=o.indexOf(e.nominee),a=o.indexOf(e.nominator),r=t.players[n].id,u=t.players[a].id;e.nomineeId=r,e.nominatorId=u})}function v(t){return t.history.length>1&&t.history[t.history.length-1].type==="end"}function w(){let t=localStorage.getItem("mastermindAccessToken");if(t){if(d(t).exp>Date.now())return!0;localStorage.removeItem("mastermindAccessToken")}return!1}function h(){let t=localStorage.getItem("token"),e=d(t).id,n=JSON.parse(localStorage.getItem("storytellers")).some(a=>a.id===e);return n||console.log("not a storyteller"),n}function c(t){fetch(T+"save-phase",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"JWT "+localStorage.getItem("mastermindAccessToken")||""},body:JSON.stringify({data:t})}).then(e=>{e.ok||(console.log("something went wrong: "+e.status+" "+e.statusText),(e.status===401||e.status===403)&&console.log("You are not authorized to use this extension. Please log in and try again."))})}chrome.runtime.onMessage.addListener(function(t,e,o){switch(t.action){case S:m();break;case k:let n=document.getElementById("mastermind-style");n&&n.remove();break;case"ALERT":alert(t.message);case E:localStorage.setItem("mastermindAccessToken",t.token),h()&&!l&&g();break;case I:localStorage.removeItem("mastermindAccessToken");break}});function A(){let t={};for(let e=0;e<localStorage.length;e++){let o=localStorage.key(e),n=localStorage.getItem(o);(n.startsWith("{")||n.startsWith("["))&&(n=JSON.parse(n)),t[o]=n}return t}
