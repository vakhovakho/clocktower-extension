class l extends Error{}l.prototype.name="InvalidTokenError";function E(t){return decodeURIComponent(atob(t).replace(/(.)/g,(e,r)=>{let n=r.charCodeAt(0).toString(16).toUpperCase();return n.length<2&&(n="0"+n),"%"+n}))}function T(t){let e=t.replace(/-/g,"+").replace(/_/g,"/");switch(e.length%4){case 0:break;case 2:e+="==";break;case 3:e+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return E(e)}catch{return atob(e)}}function g(t,e){if(typeof t!="string")throw new l("Invalid token specified: must be a string");e||(e={});const r=e.header===!0?0:1,n=t.split(".")[r];if(typeof n!="string")throw new l(`Invalid token specified: missing part #${r+1}`);let s;try{s=T(n)}catch(a){throw new l(`Invalid token specified: invalid base64 for part #${r+1} (${a.message})`)}try{return JSON.parse(s)}catch(a){throw new l(`Invalid token specified: invalid json for part #${r+1} (${a.message})`)}}const b="LOAD_STYLES",C="UNLOAD_STYLES",I="STORE_ACCESS_TOKEN",L="REMOVE_ACCESS_TOKEN",A={childList:!0,subtree:!0},h=new MutationObserver(t=>{var n;let e=document.querySelectorAll("#whispers li.video.storyteller"),r=document.querySelectorAll("ul.storytellers li.storyteller");for(let s=0;s<r.length;s++){let a=(n=r[s].querySelector("div.name span"))==null?void 0:n.innerText;for(let o=0;o<e.length;o++){let v=e[o].querySelector(".chat"),d=e[o].querySelector(".video"),w=e[o].querySelector(".audio"),m=e[o].querySelector(".name"),k=e[o].querySelector(".token");if(m.innerText.trim().startsWith(a)){e[o].style.position="fixed",e[o].style.bottom="106px",e[o].style.width="min(26vw, 26vh)",e[o].style[s===0?"left":"right"]="80px",v.style.borderRadius="50%",d.style.borderRadius="50%",d.style.borderColor="#6fbc6f",m.style.display="none",k.style.display="none",w.style.display="none";break}}}});function f(){let t=setInterval(()=>{const e=document.getElementById("center");e&&(h.observe(e,A),clearInterval(t))},2e3)}function O(){h.disconnect()}async function y(){const t=chrome.runtime.getURL("custom-css.css");return fetch(t).then(e=>e.text()).then(e=>{let r=document.getElementById("mastermind-style");r&&r.remove();var n=document.createElement("style");n.id="mastermind-style",n.type="text/css",n.innerHTML=e,document.head.appendChild(n)})}const D="https://api.clocktower.ge/v1/";window.onload=function(){chrome.storage.local.get(["styleLoaded"]).then(async e=>{if(i()&&e.styleLoaded===1)try{await y(),f()}catch(r){console.error(r)}}),chrome.storage.local.get(["translate"]).then(async e=>{console.log(i(),e.translate),!i()&&e.translate&&(console.log("removing translate"),chrome.storage.local.set({translate:!1}),chrome.runtime.sendMessage({translate:!1}))});let t=setInterval(()=>{S()&&!c&&(p(),clearInterval(t))},6e4)};let c=!1;function p(){c=!0;let t={phase:-1,ended:!1,winner:""};N(t),setInterval(()=>{console.log("tracking");let e=_();e.game.history.length!==0&&(e.game.isRunning&&e.game.phase!==t.phase?(t.phase=e.game.phase,t.ended=!1,t.winner="",u(e)):x(e.game)&&!t.ended&&(e.winner=t.winner,t.ended=!0,t.phase=-1,t.winner="",u(e)))},5e3)}function x(t){return t.history.length>1&&t.history[t.history.length-1].type==="end"}function i(){let t=localStorage.getItem("mastermindAccessToken");if(t){if(g(t).exp>Date.now())return!0;localStorage.removeItem("mastermindAccessToken")}return!1}function N(t){document.body.addEventListener("click",r=>{r.target.tagName==="LI"&&r.target.textContent.trim().toLowerCase().startsWith("reveal grimoire")&&setTimeout(e,0)}),document.addEventListener("keyup",r=>{r.key==="g"&&setTimeout(e,0)});function e(){document.querySelectorAll("button").forEach(r=>{r.addEventListener("click",()=>{let n=r.textContent.trim().toLowerCase();n.startsWith("good won")?t.winner="good":n.startsWith("evil won")&&(t.winner="evil")})})}}function S(){let t=localStorage.getItem("token"),e=g(t).id,n=JSON.parse(localStorage.getItem("storytellers")).some(s=>s.id===e);return n||console.log("not a storyteller"),n}function u(t){fetch(D+"save-phase",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"JWT "+localStorage.getItem("mastermindAccessToken")||""},body:JSON.stringify({data:t})}).then(e=>{e.ok||(console.log("something went wrong: "+e.status+" "+e.statusText),(e.status===401||e.status===403)&&console.log("You are not authorized to use this extension. Please log in and try again."))})}chrome.runtime.onMessage.addListener(function(t,e,r){switch(t.action){case b:y(),f();break;case C:let n=document.getElementById("mastermind-style");n&&n.remove(),O();break;case"ALERT":alert(t.message);case I:localStorage.setItem("mastermindAccessToken",t.token),S()&&!c&&p();break;case L:localStorage.removeItem("mastermindAccessToken"),window.location.reload();break}});function _(){let t={};for(let e=0;e<localStorage.length;e++){let r=localStorage.key(e),n=localStorage.getItem(r);(n.startsWith("{")||n.startsWith("["))&&(n=JSON.parse(n)),t[r]=n}return t}
