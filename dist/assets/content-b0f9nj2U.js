class l extends Error{}l.prototype.name="InvalidTokenError";function E(t){return decodeURIComponent(atob(t).replace(/(.)/g,(e,r)=>{let n=r.charCodeAt(0).toString(16).toUpperCase();return n.length<2&&(n="0"+n),"%"+n}))}function b(t){let e=t.replace(/-/g,"+").replace(/_/g,"/");switch(e.length%4){case 0:break;case 2:e+="==";break;case 3:e+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return E(e)}catch{return atob(e)}}function y(t,e){if(typeof t!="string")throw new l("Invalid token specified: must be a string");e||(e={});const r=e.header===!0?0:1,n=t.split(".")[r];if(typeof n!="string")throw new l(`Invalid token specified: missing part #${r+1}`);let s;try{s=b(n)}catch(a){throw new l(`Invalid token specified: invalid base64 for part #${r+1} (${a.message})`)}try{return JSON.parse(s)}catch(a){throw new l(`Invalid token specified: invalid json for part #${r+1} (${a.message})`)}}const T="LOAD_STYLES",C="UNLOAD_STYLES",w="STORE_ACCESS_TOKEN",O="REMOVE_ACCESS_TOKEN",A={childList:!0,subtree:!0},g=new MutationObserver(t=>{var n;let e=document.querySelectorAll("#whispers li.video.storyteller"),r=document.querySelectorAll("ul.storytellers li.storyteller");for(let s=0;s<r.length;s++){let a=(n=r[s].querySelector("div.name span"))==null?void 0:n.innerText;for(let o=0;o<e.length;o++){let i=e[o].querySelector(".chat"),d=e[o].querySelector(".video"),k=e[o].querySelector(".audio"),m=e[o].querySelector(".name"),I=e[o].querySelector(".token");if(m.innerText.trim().startsWith(a)){e[o].style.position="fixed",e[o].style.bottom="20px",e[o].style.width="min(32vw, 32vh)",e[o].style[s===0?"left":"right"]="80px",i.style.borderRadius="50%",d.style.borderRadius="50%",d.style.borderColor="#6fbc6f",m.style.display="none",I.style.display="none",k.style.display="none";break}}}});function f(){let t=setInterval(()=>{const e=document.getElementById("center");e&&(g.observe(e,A),clearInterval(t))},2e3)}function L(){g.disconnect()}async function p(){const t=chrome.runtime.getURL("custom-css.css");return fetch(t).then(e=>e.text()).then(e=>{let r=document.getElementById("mastermind-style");r&&r.remove();var n=document.createElement("style");n.id="mastermind-style",n.type="text/css",n.innerHTML=e,document.head.appendChild(n)})}const x="https://api.clocktower.ge/v1/";window.onload=function(){chrome.storage.local.get(["styleLoaded"]).then(async e=>{if(N()&&e.styleLoaded===1)try{await p(),f()}catch(r){console.error(r)}});let t=setInterval(()=>{v()&&!c&&(S(),clearInterval(t))},6e4)};let c=!1;function S(){c=!0;let t={phase:-1,ended:!1};setInterval(()=>{console.log("tracking");let e=_();e.game.history.length!==0&&(e.game.isRunning&&e.game.phase!==t.phase?(t.phase=e.game.phase,t.ended=!1,u(e),h(e)):D(e.game)&&!t.ended&&(t.ended=!0,t.phase=-1,u(e),h(e)))},5e3)}function u(t){t.voteHistory.forEach(e=>{let r=[...document.querySelectorAll("#center .circle li .name span")].map(i=>i.textContent),n=r.indexOf(e.nominee),s=r.indexOf(e.nominator),a=t.players[n].id,o=t.players[s].id;e.nomineeId=a,e.nominatorId=o})}function D(t){return t.history.length>1&&t.history[t.history.length-1].type==="end"}function N(){let t=localStorage.getItem("mastermindAccessToken");if(t){if(y(t).exp>Date.now())return!0;localStorage.removeItem("mastermindAccessToken")}return!1}function v(){let t=localStorage.getItem("token"),e=y(t).id,n=JSON.parse(localStorage.getItem("storytellers")).some(s=>s.id===e);return n||console.log("not a storyteller"),n}function h(t){fetch(x+"save-phase",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"JWT "+localStorage.getItem("mastermindAccessToken")||""},body:JSON.stringify({data:t})}).then(e=>{e.ok||(console.log("something went wrong: "+e.status+" "+e.statusText),(e.status===401||e.status===403)&&console.log("You are not authorized to use this extension. Please log in and try again."))})}chrome.runtime.onMessage.addListener(function(t,e,r){switch(t.action){case T:p(),f();break;case C:let n=document.getElementById("mastermind-style");n&&n.remove(),L();break;case"ALERT":alert(t.message);case w:localStorage.setItem("mastermindAccessToken",t.token),v()&&!c&&S();break;case O:localStorage.removeItem("mastermindAccessToken");break}});function _(){let t={};for(let e=0;e<localStorage.length;e++){let r=localStorage.key(e),n=localStorage.getItem(r);(n.startsWith("{")||n.startsWith("["))&&(n=JSON.parse(n)),t[r]=n}return t}
