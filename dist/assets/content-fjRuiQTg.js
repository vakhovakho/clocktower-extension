class i extends Error{}i.prototype.name="InvalidTokenError";function k(t){return decodeURIComponent(atob(t).replace(/(.)/g,(e,r)=>{let n=r.charCodeAt(0).toString(16).toUpperCase();return n.length<2&&(n="0"+n),"%"+n}))}function w(t){let e=t.replace(/-/g,"+").replace(/_/g,"/");switch(e.length%4){case 0:break;case 2:e+="==";break;case 3:e+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return k(e)}catch{return atob(e)}}function m(t,e){if(typeof t!="string")throw new i("Invalid token specified: must be a string");e||(e={});const r=e.header===!0?0:1,n=t.split(".")[r];if(typeof n!="string")throw new i(`Invalid token specified: missing part #${r+1}`);let s;try{s=w(n)}catch(a){throw new i(`Invalid token specified: invalid base64 for part #${r+1} (${a.message})`)}try{return JSON.parse(s)}catch(a){throw new i(`Invalid token specified: invalid json for part #${r+1} (${a.message})`)}}const E="LOAD_STYLES",T="UNLOAD_STYLES",b="STORE_ACCESS_TOKEN",C="REMOVE_ACCESS_TOKEN",L={childList:!0,subtree:!0},h=new MutationObserver(t=>{var n;let e=document.querySelectorAll("#whispers li.video.storyteller"),r=document.querySelectorAll("ul.storytellers li.storyteller");for(let s=0;s<r.length;s++){let a=(n=r[s].querySelector("div.name span"))==null?void 0:n.innerText;for(let o=0;o<e.length;o++){let p=e[o].querySelector(".chat"),l=e[o].querySelector(".video"),S=e[o].querySelector(".audio"),c=e[o].querySelector(".name"),v=e[o].querySelector(".token");if(c.innerText.trim().startsWith(a)){e[o].style.position="fixed",e[o].style.bottom="106px",e[o].style.width="min(26vw, 26vh)",e[o].style[s===0?"left":"right"]="80px",p.style.borderRadius="50%",l.style.borderRadius="50%",l.style.borderColor="#6fbc6f",c.style.display="none",v.style.display="none",S.style.display="none";break}}}});function g(){let t=setInterval(()=>{const e=document.getElementById("center");e&&(h.observe(e,L),clearInterval(t))},2e3)}function I(){h.disconnect()}async function y(){const t=chrome.runtime.getURL("custom-css.css");return fetch(t).then(e=>e.text()).then(e=>{let r=document.getElementById("mastermind-style");r&&r.remove();var n=document.createElement("style");n.id="mastermind-style",n.type="text/css",n.innerHTML=e,document.head.appendChild(n)})}const A="https://api.clocktower.ge/v1/";function O(t){return t.history.length>1&&t.history[t.history.length-1].type==="end"}function x(){let t=localStorage.getItem("mastermindAccessToken");if(t){if(m(t).exp>Date.now())return!0;localStorage.removeItem("mastermindAccessToken")}return!1}window.onload=function(){if(!x()){setTimeout(()=>{alert("You are not authorized to use this extension. Please log in and try again.")},5e3);return}N()&&f()};let d=!1;function f(){if(d)return;d=!0;let t={phase:-1,ended:!1,winner:""};D(t),setInterval(()=>{console.log("tracking");let e=_();e.game.history.length!==0&&(e.game.isRunning&&e.game.phase!==t.phase?(t.phase=e.game.phase,t.ended=!1,t.winner="",u(e)):O(e.game)&&!t.ended&&(e.winner=t.winner,t.ended=!0,t.phase=-1,t.winner="",u(e)))},5e3)}function D(t){document.body.addEventListener("click",r=>{r.target.tagName==="LI"&&r.target.textContent.trim().toLowerCase().startsWith("reveal grimoire")&&setTimeout(e,0)}),document.addEventListener("keyup",r=>{r.key==="g"&&setTimeout(e,0)});function e(){document.querySelectorAll("button").forEach(r=>{r.addEventListener("click",()=>{let n=r.textContent.trim().toLowerCase();n.startsWith("good won")?t.winner="good":n.startsWith("evil won")&&(t.winner="evil")})})}}function N(){let t=localStorage.getItem("token"),e=m(t).id,n=JSON.parse(localStorage.getItem("storytellers")).some(s=>s.id===e);return n||console.log("not a storyteller"),n}function u(t){fetch(A+"save-phase",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"JWT "+localStorage.getItem("mastermindAccessToken")||""},body:JSON.stringify({data:t})}).then(e=>{e.ok||(console.log("something went wrong: "+e.status+" "+e.statusText),(e.status===401||e.status===403)&&console.log("You are not authorized to use this extension. Please log in and try again."))})}chrome.storage.local.get(["styleLoaded"]).then(async t=>{if(t.styleLoaded===1)try{await y(),g()}catch(e){console.error(e)}});chrome.runtime.onMessage.addListener(function(t,e,r){switch(t.action){case E:y(),g();break;case T:let n=document.getElementById("mastermind-style");n&&n.remove(),I();break;case"ALERT":alert(t.message);case b:localStorage.setItem("mastermindAccessToken",t.token),f();break;case C:localStorage.removeItem("mastermindAccessToken");break}});function _(){let t={};for(let e=0;e<localStorage.length;e++){let r=localStorage.key(e),n=localStorage.getItem(r);(n.startsWith("{")||n.startsWith("["))&&(n=JSON.parse(n)),t[r]=n}return t}
