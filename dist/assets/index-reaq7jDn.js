(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))t(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const c of a.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&t(c)}).observe(document,{childList:!0,subtree:!0});function r(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerPolicy&&(a.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?a.credentials="include":o.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function t(o){if(o.ep)return;o.ep=!0;const a=r(o);fetch(o.href,a)}})();class d extends Error{}d.prototype.name="InvalidTokenError";function v(e){return decodeURIComponent(atob(e).replace(/(.)/g,(n,r)=>{let t=r.charCodeAt(0).toString(16).toUpperCase();return t.length<2&&(t="0"+t),"%"+t}))}function C(e){let n=e.replace(/-/g,"+").replace(/_/g,"/");switch(n.length%4){case 0:break;case 2:n+="==";break;case 3:n+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return v(n)}catch{return atob(n)}}function E(e,n){if(typeof e!="string")throw new d("Invalid token specified: must be a string");n||(n={});const r=n.header===!0?0:1,t=e.split(".")[r];if(typeof t!="string")throw new d(`Invalid token specified: missing part #${r+1}`);let o;try{o=C(t)}catch(a){throw new d(`Invalid token specified: invalid base64 for part #${r+1} (${a.message})`)}try{return JSON.parse(o)}catch(a){throw new d(`Invalid token specified: invalid json for part #${r+1} (${a.message})`)}}const L="LOAD_STYLES",k="UNLOAD_STYLES",w="STORE_ACCESS_TOKEN",S="REMOVE_ACCESS_TOKEN",h="http://localhost:8000/v1/";let b={PLAYER:"player",STORYTELLER:"storyteller",SPECTATOR:"spectator"},T={bocToken:null,bocId:null,userType:null,players:[],storytellers:[],spectators:[]},s=T,i=document.querySelector(".wrapper"),m=document.getElementById("style");chrome.storage.local.get(["styleLoaded"],function(e){e.styleLoaded&&(m.checked=!0)});m.addEventListener("change",function(){m.checked?(chrome.storage.local.set({styleLoaded:1}),chrome.tabs.query({active:!0,currentWindow:!0},function(e){chrome.tabs.sendMessage(e[0].id,{action:L})})):(chrome.storage.local.set({styleLoaded:0}),chrome.tabs.query({active:!0,currentWindow:!0},function(e){chrome.tabs.sendMessage(e[0].id,{action:k})}))});chrome.runtime.onMessage.addListener(function(e,n,r){console.log("localStorage change detected",e.data),e.gameEnded&&console.log("localStorage change detected",e.data)});P(function(){return{token:localStorage.getItem("token"),game:JSON.parse(localStorage.getItem("game")),players:JSON.parse(localStorage.getItem("players")),storytellers:JSON.parse(localStorage.getItem("storytellers")),playerNames:[...document.querySelectorAll(".nameplate span")].map(e=>e.textContent)}},function(e){I(e)});function I(e){let{token:n,game:r,players:t,storytellers:o,playerNames:a}=e;if(!n){y("You must be logged in to rate players.");return}s.bocToken=n,s.bocId=E(n).id,s.game=r,s.players=t,s.storytellers=o,s.playerNames=a,t.find(c=>c.id===s.bocId)?s.userType=b.PLAYER:o.find(c=>c.id===s.bocId)&&(s.userType=b.STORYTELLER),O()?g():f()}function O(){let e=localStorage.getItem("accessToken");if(e){if(E(e).exp>Date.now())return!0;localStorage.removeItem("accessToken")}return!1}function f(){i.innerHTML="";let e=document.createElement("div");e.classList.add("auth-container");let n=document.createElement("div"),r=document.createElement("label");r.textContent="username",r.for="username";let t=document.createElement("input");t.setAttribute("name","username"),t.setAttribute("id","username"),n.appendChild(r),n.appendChild(t);let o=document.createElement("div"),a=document.createElement("label");a.textContent="password",a.for="password";let c=document.createElement("input");c.setAttribute("type","password"),c.setAttribute("name","password"),c.setAttribute("id","password"),o.appendChild(a),o.appendChild(c);let l=document.createElement("div"),u=document.createElement("button");u.textContent="Login";let p=document.createElement("button");p.textContent="Register",l.appendChild(u),l.appendChild(p),e.appendChild(n),e.appendChild(o),e.appendChild(l),i.appendChild(e),u.addEventListener("click",()=>A(t.value,c.value,s.bocId)),p.addEventListener("click",()=>N(t.value,c.value,s.bocId))}function A(e,n,r){fetch(h+"auth/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:e,password:n,bocId:r})}).then(t=>{if(!t.ok)throw new Error("something went wrong");return t.json()}).then(t=>{localStorage.setItem("accessToken",t.accessToken),chrome.tabs.query({active:!0,currentWindow:!0},function(o){chrome.tabs.sendMessage(o[0].id,{action:w,token:t.accessToken})}),g()}).catch(t=>{alert("something went wrong: "+t.message)})}function N(e,n,r){fetch(h+"auth/register",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:e,password:n,bocId:r})}).then(t=>{if(!t.ok)throw new Error("something went wrong");return t.json()}).then(t=>{g(),localStorage.setItem("accessToken",t.accessToken),chrome.tabs.query({active:!0,currentWindow:!0},function(o){chrome.tabs.sendMessage(o[0].id,{action:w,token:t.accessToken})})}).catch(t=>{alert("something went wrong: "+t.message)})}function R(e,n,r){fetch(h+"vote",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"JWT "+localStorage.getItem("accessToken")||""},body:JSON.stringify({senderId:e,senderStatus:n,receiverId:r})}).then(t=>{if(!t.ok)if(t.status===401||t.status===403)localStorage.removeItem("accessToken"),chrome.tabs.query({active:!0,currentWindow:!0},function(o){chrome.tabs.sendMessage(o[0].id,{action:S})}),f();else throw new Error("Something went wrong");return t.json()}).then(t=>{if(t.status==="error")throw new Error(t.message);alert("Vote sent")}).catch(t=>{alert("Error: "+t.message)})}function _(){localStorage.removeItem("accessToken"),chrome.tabs.query({active:!0,currentWindow:!0},function(e){chrome.tabs.sendMessage(e[0].id,{action:S})}),f()}function g(){if(i.innerHTML="",!s.userType){y("You must be a player or storyteller to rate players.");return}let e=document.createElement("span");e.classList.add("logout"),e.textContent="Logout",e.addEventListener("click",_),i.appendChild(e);for(let r in s.players){let t=s.players[r].id,o=s.playerNames[r],a=document.createElement("div");a.classList.add("player");let c=document.createElement("label");c.setAttribute("for",t+"_"+r),c.textContent=o;let l=document.createElement("input");l.type="radio",l.setAttribute("name","vote"),l.value=t,l.id=t+"_"+r,a.appendChild(c),a.appendChild(l),i.appendChild(a)}let n=document.createElement("button");n.textContent="Rate",n.addEventListener("click",x),i.appendChild(n)}function x(){let e=document.querySelector('input[name="vote"]:checked');if(!e){alert("Please select a player to vote");return}let n=e.value;R(s.bocId,s.userType,n)}function P(e,n){chrome.tabs.query({active:!0,currentWindow:!0},function(r){const t=r[0];t&&(t.url.includes("online.bloodontheclocktower.com")?chrome.scripting.executeScript({target:{tabId:t.id},function:e},function(o){n&&n(o[0].result)}):y("You must be on the Blood on the Clocktower website to use this extension."))})}function y(e){i.innerHTML="",i.textContent=e,i.classList.add("error"),s=T}
